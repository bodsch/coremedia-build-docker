# 
# Copyright 2022 Martin Goellnitz
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Build and Push CMCC

on:
  push:
    branches: [ cmcc-11-actions ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/repository
        key: cmcc11
        restore-keys: cmcc11
    - name: Configure Workspace
      run: mkdir -p ~/.m2 && cp workspace-configuration/maven-settings.xml ~/.m2/settings.xml
    - name: Derive Build Date
      run: |
        BUILD_DATE=$(git log -n 1 --date='format:%Y-%m-%dT%H:%M:%SZ' --format="%ad")
        find -name pom.xml -exec \
          sed -i "s/project.build.outputTimestamp.202[0-9].[0-1][0-9].[0-3][0-9]T[0-9][0-9]:[0-9][0-9]:[0-9][0-9]Z..project.build.outputTimestamp/project.build.outputTimestamp\\>$BUILD_DATE\\<\\/project.build.outputTimestamp/" {} \;
    - name: Prepare Version Tags
      run: |
        sed -i -e 's/customer.Blueprint..customer/customer>PROVOCON<\/customer/g' $(find -name "pom.xml"|grep blueprint-parent)
        VERSION_AFTER=$(echo "${CI_COMMIT_REF_NAME}"|sed -e 's/^v\(.*\)-CMCC/\1/g'|sed -e 's/^cmcc.*/1-SNAPSHOT/g')
        VERSION_STRING=`head -15 pom.xml |tail -5 |grep version`
        VERSION_BEFORE=`echo $VERSION_STRING|sed -e 's/.*version.\(.*\)..version.*/\1/g'`
        echo "$BUILD_DATE: $VERSION_BEFORE -> $VERSION_AFTER"
        if [ "$VERSION_BEFORE" = "$VERSION_AFTER" ] ; then
          find -name pom.xml -exec sed -i "s/version.$VERSION_BEFORE..version/version\\>$VERSION_AFTER\\<\\/version/" {} \;
          find -name pom.xml -exec sed -i "s/\(<cm.[a-z\-]*.bp.version>\)1-SNAPSHOT\(<\/.*>\)/\1$VERSION_AFTER\2/g" {} \;
        fi
    - name: Build Artifacts
      env:
        CM_MAVEN_USER: ${{ secrets.CM_MAVEN_USER }}
        CM_MAVEN_PASSWORD: ${{ secrets.CM_MAVEN_PASSWORD }}
      run: |
        mvn install -Pdefault-image -Dmaven.compiler.forceJavacCompilerUse=true \
        -B --no-transfer-progress -Dorg.slf4j.simpleLogger.defaultLogLevel=warn \
        -DskipContent=true -DskipThemes=true -Dskip-joo-unit-tests=true \
        -DjooUnitWebDriverBrowserArguments=--no-sandbox,--disable-dev-shm-usage \
        -Dwebdriver.chrome.verboseLogging=true \
        -Dwebdriver.chrome.driver=/usr/bin/chromedriver \
        -Dtest='!com.coremedia.**,!com.coremedia.blueprint.connectors.canto.rest.services.*' \
        -DfailIfNoTests=false
